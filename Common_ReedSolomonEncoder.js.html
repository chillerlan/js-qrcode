<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Common/ReedSolomonEncoder.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Common/ReedSolomonEncoder.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @created      11.07.2022
 * @author       smiley &lt;smiley@chillerlan.net>
 * @copyright    2022 smiley
 * @license      MIT
 */

import PHPJS from './PHPJS.js';
import GenericGFPoly from './GenericGFPoly.js';
import GF256 from './GF256.js';

/**
 * ISO/IEC 18004:2000 Section 8.5 ff
 *
 * @see http://www.thonky.com/qr-code-tutorial/error-correction-coding
 */
export default class ReedSolomonEncoder{

	/**
	 * @type {{}}
	 * @private
	 */
	interleavedData;

	/**
	 * @type {int}
	 * @private
	 */
	interleavedDataIndex;

	/**
	 * ECC interleaving
	 *
	 * @param {BitBuffer} $bitBuffer
	 * @param {Version} $version
	 * @param {EccLevel} $eccLevel
	 *
	 * @returns {{}}
	 * @throws \chillerlan\QRCode\QRCodeException
	 */
	interleaveEcBytes($bitBuffer, $version, $eccLevel){
		let $rsblockData     = $version.getRSBlocks($eccLevel);
		let $numEccCodewords = $rsblockData[0];
		let $l1              = $rsblockData[1][0][0];
		let $b1              = $rsblockData[1][0][1];
		let $l2              = $rsblockData[1][1][0];
		let $b2              = $rsblockData[1][1][1];
		let $rsBlocks        = PHPJS.fill_array($l1, [$numEccCodewords + $b1, $b1]);

		if($l2 > 0){
			$rsBlocks = PHPJS.array_merge($rsBlocks, PHPJS.fill_array($l2, [$numEccCodewords + $b2, $b2]));
		}


		let $bitBufferData  = $bitBuffer.getBuffer();
		let $dataBytes      = [];
		let $ecBytes        = [];
		let $maxDataBytes   = 0;
		let $maxEcBytes     = 0;
		let $dataByteOffset = 0;

		for(let $key in $rsBlocks){
			let $rsBlockTotal  = $rsBlocks[$key][0];
			let $dataByteCount = $rsBlocks[$key][1];

			$dataBytes[$key]   = [];

			for(let $i = 0; $i &lt; $dataByteCount; $i++){
				$dataBytes[$key][$i] = $bitBufferData[$i + $dataByteOffset] &amp; 0xff;
			}

			let $ecByteCount = $rsBlockTotal - $dataByteCount;
			$ecBytes[$key]   = this.generateEcBytes($dataBytes[$key], $ecByteCount);
			$maxDataBytes    = Math.max($maxDataBytes, $dataByteCount);
			$maxEcBytes      = Math.max($maxEcBytes, $ecByteCount);
			$dataByteOffset += $dataByteCount;
		}

		this.interleavedData      = PHPJS.fill_array($version.getTotalCodewords(), 0);
		this.interleavedDataIndex = 0;
		let $numRsBlocks          = $l1 + $l2;

		this.interleave($dataBytes, $maxDataBytes, $numRsBlocks);
		this.interleave($ecBytes, $maxEcBytes, $numRsBlocks);

		return this.interleavedData;
	}

	/**
	 * @param {Array} $dataBytes
	 * @param {int} $ecByteCount
	 *
	 * @returns {{}}
	 * @private
	 */
	generateEcBytes($dataBytes, $ecByteCount){
		let $rsPoly = new GenericGFPoly([1]);

		for(let $i = 0; $i &lt; $ecByteCount; $i++){
			$rsPoly = $rsPoly.multiply(new GenericGFPoly([1, GF256.exp($i)]));
		}

		let $rsPolyDegree    = $rsPoly.getDegree();
		let $modCoefficients = (new GenericGFPoly($dataBytes, $rsPolyDegree))
			.mod($rsPoly)
			.getCoefficients()
		;

		let $ecBytes = PHPJS.fill_array($rsPolyDegree, 0);
		let $count   = $modCoefficients.length - $rsPolyDegree;

		for(let $i = 0; $i &lt; $ecBytes.length; $i++){
			let $modIndex = $i + $count;
			$ecBytes[$i]  = $modIndex >= 0 ? $modCoefficients[$modIndex] : 0;
		}

		return $ecBytes;
	}

	/**
	 * @param {{}} $byteArray
	 * @param {int} $maxBytes
	 * @param {int} $numRsBlocks
	 *
	 * @returns {void}
	 * @private
	 */
	interleave($byteArray, $maxBytes, $numRsBlocks){
		for(let $x = 0; $x &lt; $maxBytes; $x++){
			for(let $y = 0; $y &lt; $numRsBlocks; $y++){
				if($x &lt; $byteArray[$y].length){
					this.interleavedData[this.interleavedDataIndex++] = $byteArray[$y][$x];
				}
			}
		}
	}

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="EccLevel.html">EccLevel</a></li><li><a href="MaskPattern.html">MaskPattern</a></li><li><a href="Mode.html">Mode</a></li><li><a href="module.exports.html">exports</a></li><li><a href="QRMatrix.html">QRMatrix</a></li><li><a href="Version.html">Version</a></li></ul><h3>Interfaces</h3><ul><li><a href="QROutputInterface.html">QROutputInterface</a></li></ul><h3>Global</h3><ul><li><a href="global.html#%255Cchillerlan%255CQRCode%255CData%255CQRDataModeInterface">\chillerlan\QRCode\Data\QRDataModeInterface</a></li><li><a href="global.html#_set_circleRadius">_set_circleRadius</a></li><li><a href="global.html#_set_eccLevel">_set_eccLevel</a></li><li><a href="global.html#_set_logoSpaceHeight">_set_logoSpaceHeight</a></li><li><a href="global.html#_set_logoSpaceStartX">_set_logoSpaceStartX</a></li><li><a href="global.html#_set_logoSpaceStartY">_set_logoSpaceStartY</a></li><li><a href="global.html#_set_logoSpaceWidth">_set_logoSpaceWidth</a></li><li><a href="global.html#_set_maskPattern">_set_maskPattern</a></li><li><a href="global.html#_set_quietzoneSize">_set_quietzoneSize</a></li><li><a href="global.html#_set_version">_set_version</a></li><li><a href="global.html#_set_versionMax">_set_versionMax</a></li><li><a href="global.html#_set_versionMin">_set_versionMin</a></li><li><a href="global.html#addAlphaNumSegment">addAlphaNumSegment</a></li><li><a href="global.html#addByteSegment">addByteSegment</a></li><li><a href="global.html#addNumericSegment">addNumericSegment</a></li><li><a href="global.html#addSegment">addSegment</a></li><li><a href="global.html#array_combine">array_combine</a></li><li><a href="global.html#array_merge">array_merge</a></li><li><a href="global.html#array_search">array_search</a></li><li><a href="global.html#available">available</a></li><li><a href="global.html#base64encode">base64encode</a></li><li><a href="global.html#CHAR_TO_ORD">CHAR_TO_ORD</a></li><li><a href="global.html#clampLogoSpaceValue">clampLogoSpaceValue</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#clearSegments">clearSegments</a></li><li><a href="global.html#collectModules">collectModules</a></li><li><a href="global.html#createMarkup">createMarkup</a></li><li><a href="global.html#dump">dump</a></li><li><a href="global.html#exp">exp</a></li><li><a href="global.html#fill_array">fill_array</a></li><li><a href="global.html#getBuffer">getBuffer</a></li><li><a href="global.html#getCharCount">getCharCount</a></li><li><a href="global.html#getCoefficient">getCoefficient</a></li><li><a href="global.html#getCoefficients">getCoefficients</a></li><li><a href="global.html#getCssClass">getCssClass</a></li><li><a href="global.html#getDataMode">getDataMode</a></li><li><a href="global.html#getDefaultModuleValue">getDefaultModuleValue</a></li><li><a href="global.html#getDegree">getDegree</a></li><li><a href="global.html#getLength">getLength</a></li><li><a href="global.html#getLengthInBits">getLengthInBits</a></li><li><a href="global.html#getMatrix">getMatrix</a></li><li><a href="global.html#getModuleValue">getModuleValue</a></li><li><a href="global.html#header">header</a></li><li><a href="global.html#initCustomOutputInterface">initCustomOutputInterface</a></li><li><a href="global.html#initOutputInterface">initOutputInterface</a></li><li><a href="global.html#interleaveEcBytes">interleaveEcBytes</a></li><li><a href="global.html#intval">intval</a></li><li><a href="global.html#IS_DARK">IS_DARK</a></li><li><a href="global.html#isset">isset</a></li><li><a href="global.html#isZero">isZero</a></li><li><a href="global.html#json">json</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#M_ALIGNMENT">M_ALIGNMENT</a></li><li><a href="global.html#M_DARKMODULE">M_DARKMODULE</a></li><li><a href="global.html#M_DATA">M_DATA</a></li><li><a href="global.html#M_FINDER">M_FINDER</a></li><li><a href="global.html#M_FINDER_DOT">M_FINDER_DOT</a></li><li><a href="global.html#M_FORMAT">M_FORMAT</a></li><li><a href="global.html#M_LOGO">M_LOGO</a></li><li><a href="global.html#M_NULL">M_NULL</a></li><li><a href="global.html#M_QUIETZONE">M_QUIETZONE</a></li><li><a href="global.html#M_SEPARATOR">M_SEPARATOR</a></li><li><a href="global.html#M_TEST">M_TEST</a></li><li><a href="global.html#M_TIMING">M_TIMING</a></li><li><a href="global.html#M_VERSION">M_VERSION</a></li><li><a href="global.html#MASK_PATTERN_AUTO">MASK_PATTERN_AUTO</a></li><li><a href="global.html#MATRIX_NEIGHBOUR_FLAGS">MATRIX_NEIGHBOUR_FLAGS</a></li><li><a href="global.html#MATRIX_NEIGHBOURS">MATRIX_NEIGHBOURS</a></li><li><a href="global.html#mod">mod</a></li><li><a href="global.html#MODE_INTERFACES">MODE_INTERFACES</a></li><li><a href="global.html#MODE_LENGTH_BITS">MODE_LENGTH_BITS</a></li><li><a href="global.html#module">module</a></li><li><a href="global.html#MODULE_VALUES_KEYS">MODULE_VALUES_KEYS</a></li><li><a href="global.html#moduleValueIsValid">moduleValueIsValid</a></li><li><a href="global.html#multiply">multiply</a></li><li><a href="global.html#ord">ord</a></li><li><a href="global.html#OUTPUT_MODE_INTERFACES">OUTPUT_MODE_INTERFACES</a></li><li><a href="global.html#paths">paths</a></li><li><a href="global.html#put">put</a></li><li><a href="global.html#putBit">putBit</a></li><li><a href="global.html#read">read</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#saveToFile">saveToFile</a></li><li><a href="global.html#setData">setData</a></li><li><a href="global.html#setMatrixDimensions">setMatrixDimensions</a></li><li><a href="global.html#setMinMaxVersion">setMinMaxVersion</a></li><li><a href="global.html#setModuleValues">setModuleValues</a></li><li><a href="global.html#text">text</a></li><li><a href="global.html#toHtmlElement">toHtmlElement</a></li><li><a href="global.html#TOTAL_CODEWORDS">TOTAL_CODEWORDS</a></li><li><a href="global.html#validateString">validateString</a></li><li><a href="global.html#validateStringI">validateStringI</a></li><li><a href="global.html#VERSION_AUTO">VERSION_AUTO</a></li><li><a href="global.html#write">write</a></li><li><a href="global.html#writeMatrix">writeMatrix</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Sun Jul 24 2022 13:21:10 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
